<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-list/core-list.html">
<link rel="import" href="../bower_components/firebase-element/firebase-element.html">
<link rel="import" href="../bower_components/firebase-element/firebase-login.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<polymer-element name="game-list">
  <template>
    <pvc-globals values="{{app}}"></pvc-globals>
    <firebase-element id="gamesRef" location="{{app.db}}/games" data="{{games}}" keys="{{keys}}"></firebase-element>
    <firebase-login location="https://cognito-game.firebaseio.com" id="login" on-login="{{handleLogin}}"></firebase-login>
    
    <style>
      :host {
        display: block;
      }
      paper-button {
        display: block;
        background: #333;
        color: white;
        font-weight: bold;
        text-align: center;
        margin: 10px;
      }
    </style>
    <template if="{{keys.length > 0}}">
      <section id="list">
        <template repeat="{{key in keys}}">
          <div class="game" on-tap="{{joinGame}}" data-game="{{key}}">
            <span class='name'>{{games[key].name}}</span>
            <span class='type'>{{games[key].type}}</span>
          </div>
        </template>
      </section>
    </template>
    <template if="{{keys.length == 0}}">
      <section id="welcome">
        <p>Welcome to the <b>Cognito Corporation</b> volunteer test subject program.</p>
      </section>
    </template>
    <paper-button on-tap="{{createGame}}" label="Begin New Experiment"/>
  </template>
  <script>
    Polymer({
      createGame: function() {
        if (this.app.user || this.$.login.user) {
          var displayName = this.app.user.thirdPartyUserData.first_name + ' ' + this.app.user.thirdPartyUserData.last_name.substr(0,1) + '.';
          this.$.gamesRef.push({
            host: this.app.user.uid,
            name: displayName,
            status: 'lobby',
            players: [{id: this.app.user.uid, name: displayName}]
          });
        } else {
          this.$.login.login('facebook');
        }
      },
      joinGame: function(e) {
        history.pushState({}, '', "/games/" + e.currentTarget.dataset.game);
        this.app.gameId = e.currentTarget.dataset.game;
      },
      handleLogin: function() {
        this.app.user = this.$.login.user;
      }
    });
  </script>
</polymer-element>
